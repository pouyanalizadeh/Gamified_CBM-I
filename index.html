<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>IB Training — Visual Skin</title>

<style>
  *{box-sizing:border-box}
  html,body{height:100%; margin:0}
  body{background:#fff;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; overflow:hidden}

  /* ===== Stage / Background ===== */
  .frame{
    position: relative;
    width: 100vw;
    height: calc(var(--vh, 1vh) * 100); /* Reliable full height on mobile */
    /* Size of the ART itself, preserving the PNG’s 9:19.5 ratio */
    --artW: min(100vw, calc(100dvh * 9 / 19.5));
    --artH: min(100dvh, calc(100vw * (19.5 / 9)));

    background: url("Main_frame.png") center top / contain no-repeat #fff;
    overflow: hidden;
    touch-action: none;
  }
  .frame, .frame *{
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  .scene,.targets,.ship-wrap,#startOverlay,#bigRetry,#successOverlay,#overlay{position:absolute; z-index:5}
  .bar{display:none}

  /* ===== Scenario card ===== */
  .scene{
    left:50%; transform:translateX(-50%);
    width:min(560px,78vw);
    top:16%; height:14%;
    display:flex; align-items:center; justify-content:center;
    padding:12px 14px; text-align:center; white-space:pre-wrap;
    color:#2A5E78; font-weight:600; letter-spacing:.1px;
    font-size: clamp(14px, 2.5vw, 18px);
    line-height: 1.25;
    overflow:hidden;
    word-break:break-word;
    hyphens:auto;
  }

  /* ===== Targets ===== */
  .targets{
    left:50%; transform:translateX(-50%); width:min(560px,78vw);
    top:38.5%; display:flex; gap:12px; justify-content:space-between;
    visibility:visible;
  }
  .target{
    flex:1; min-height:46px;
    display:flex; align-items:center; justify-content:center;
    padding:10px 12px; text-align:center; user-select:none;
    color:#1F4F66; font-weight:700; letter-spacing:.15px; line-height:1.2;
    background:url("Answer_holder.png") center/100% 100% no-repeat;
    border:none; border-radius:999px;
    filter:drop-shadow(0 6px 10px rgba(36,94,121,.08));
    font-size: clamp(13px, 2.3vw, 16px);
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
    white-space: nowrap;
    overflow: hidden;
  }
  .target .slot{ min-width:.6em; font-weight:800 }

  @keyframes gentleShake{
    0%{transform:translate(0,0) rotate(0)}
    20%{transform:translate(1px,-1px) rotate(-.35deg)}
    40%{transform:translate(-1px,.6px) rotate(.35deg)}
    60%{transform:translate(.6px,1px) rotate(-.25deg)}
    80%{transform:translate(-.6px,-1px) rotate(.25deg)}
    100%{transform:translate(0,0) rotate(0)}
  }
  .target.shake{animation:gentleShake .65s ease-in-out infinite}
  @media (prefers-reduced-motion:reduce){.target.shake{animation:none}}

  .target.goodflash{animation:good 300ms ease}
  .target.badflash{animation:bad 300ms ease}
  @keyframes good{from{outline:2px solid #2bb; filter:brightness(1.05)} to{outline:0}}
  @keyframes bad {from{outline:2px solid #b66; filter:contrast(1.03)} to{outline:0}}
  @keyframes reinforcePop {0%{transform:scale(1)}40%{transform:scale(1.03)}100%{transform:scale(1)}}
  .target.reinforce{animation:reinforcePop 280ms ease}

  .target.aim{
    transform: translateZ(0) scale(1.015);
    box-shadow:
      0 6px 10px rgba(36,94,121,.08),
      0 0 0 2px rgba(115,177,199,.25) inset,
      0 0 20px rgba(115,177,199,.12);
  }
  @keyframes targetRipple {from{box-shadow:0 0 0 0 rgba(115,177,199,.28)} to{box-shadow:0 0 0 12px rgba(115,177,199,0)}}
  .target.ripple{animation: targetRipple 320ms ease-out}

  /* ===== Start/Home overlay ===== */
  #startOverlay{
    inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.10); z-index:100;
    pointer-events:auto;
  }
  /* Ensure overlays fill the real viewport height on phones */
  #startOverlay, #successOverlay, #overlay, #bigRetry{
    min-height: calc(var(--vh, 1vh) * 100);
  }

  .homeCard{
    width:min(720px,92vw);
    background:#ffffffcc;
    border:1px dashed #7FB5C9;
    border-radius:16px;
    box-shadow:0 14px 36px rgba(0,0,0,.14);
    color:#1F4F66;
    backdrop-filter: blur(3px);
    max-height: calc(var(--vh, 1vh) * 100 - 32px); /* keep fully visible on short phones */
    overflow: auto;
  }
  .homeHeader{
    padding:14px 16px 8px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .homeTitle{
    margin:0; font-weight:900; letter-spacing:.2px;
    font-size: clamp(18px,4.5vw,24px);
  }
  .homeNav{
    display:flex; gap:8px; padding:0 16px 8px;
    flex-wrap:wrap;
  }
  .tabBtn{
    border:1px solid #73B1C7; background:#fff; color:#1F4F66;
    font-weight:800; padding:8px 12px; border-radius:999px; cursor:pointer;
  }
  .tabBtn.active{ background:#E9F4F8 }
  .homeBody{ padding:0 16px 12px }
  .homeSec{ display:block }
  .homeSec.hidden{ display:none }
  .homeActions{
    padding:12px 16px 16px; display:flex; gap:8px; justify-content:flex-end;
  }

  .scoreList{
    margin:8px 0 0; padding:0; list-style:none;
    max-height:min(40vh,300px); overflow:auto;
    border:1px solid rgba(115,177,199,.35); border-radius:10px;
  }
  .scoreList li{
    padding:8px 10px; display:flex; justify-content:space-between; align-items:center;
    border-bottom:1px dashed rgba(115,177,199,.25);
    font-size:14px;
  }
  .scoreList li:last-child{ border-bottom:0 }

  .btn{
    border:1px solid #73B1C7; background:#fff; color:#1F4F66;
    font-weight:800; padding:12px 24px; border-radius:12px; cursor:pointer;
    box-shadow:0 10px 24px rgba(0,0,0,.12);
  }
  .btnSmall{ padding:6px 10px; font-size:12px; border-radius:10px }

  /* ===== Ship ===== */
  .ship-wrap{ left:0; right:0; bottom:25%; height:90px; z-index:8 }
  #shipBtn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:0;
    pointer-events:none;
    touch-action:none;
    user-select:none;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
    background:transparent;
    border:0;
    padding:0;
    width:96px;
    height:96px;
    will-change:left;
    cursor:pointer;
  }
  #shipBtn img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    filter:drop-shadow(0 8px 14px rgba(36,94,121,.18));
    pointer-events:none;
    -webkit-user-drag:none;
    -webkit-touch-callout:none;
    user-select:none;
  }
  #shipBtn:active img{transform:translateY(1px) scale(.995)}

  /* ===== Tiny Home button during play (pinned via JS) ===== */
  #homeBtn{
    position:absolute; z-index:120; display:none;
    /* top/left set by JS to keep it inside the artwork */
  }

  /* ===== Hearts ===== */
  .heart{position:absolute; left:0; top:0; transform:translate(-50%,-50%); font-size:18px; pointer-events:none; user-select:none; z-index:999}
  .heart.letter{font-size:28px; text-shadow:0 0 1px rgba(0,0,0,.45)}
  .heart.letter .letterglyph{
    display:inline-block; margin-left:4px; padding:2px 7px; border-radius:999px;
    border:1px solid rgba(31,79,102,.7); background:#fff; font-weight:800; font-size:20px; line-height:1;
    box-shadow:0 1px 2px rgba(0,0,0,.2)
  }

  /* ===== Overlays ===== */
  #bigRetry,#successOverlay,#overlay{
    inset:0; display:none; align-items:center; justify-content:center; z-index:90;
    background:rgba(255,255,255,.88);
  }
  #bigRetry .msg{
    font-weight:900; font-size:clamp(28px,7vw,56px);
    padding:18px 28px; border-radius:12px; border:2px dashed #7FB5C9; color:#1F4F66; background:#fff;
    box-shadow:0 10px 28px rgba(0,0,0,.18)
  }
  #successOverlay .panel,#overlay .panel{
    max-width:86%; border:1px dashed #7FB5C9; border-radius:12px; padding:16px; background:#fff; text-align:center;
    color:#1F4F66; box-shadow:0 10px 28px rgba(0,0,0,.18)
  }

  .hidden{display:none}
  .slot{display:inline-block; min-width:.7em; text-align:center}
  @keyframes slotPulse{0%{opacity:.8}50%{opacity:1}100%{opacity:.8}}
  .slot.pulse{animation:slotPulse 700ms ease-in-out infinite}

  /* ===== Top HUD (Timer + Tries) ===== */
  .hudTop{
    position:absolute; z-index:20;
    top:10px; left:50%; transform:translateX(-50%);
    display:flex; flex-direction:column; align-items:center; gap:4px;
    pointer-events:none;
    transition: opacity .15s ease;
  }
  .hudScore{ display:none }

  .hudTimer{
    font-weight:900;
    font-size: clamp(24px, 6.5vw, 36px);
    line-height:1;
    color:#1F4F66;
    text-shadow:0 2px 10px rgba(31,79,102,.15);
  }
  .hudTries{
    font-weight:700;
    font-size: clamp(12px, 2.8vw, 14px);
    line-height:1;
    color:#2A5E78;
    opacity:.9;
  }

  /* ===== Pinned Session Progress (on artwork) ===== */
  .sessionWrap{
    position:absolute; z-index:30;
    left:0; top:0;
    width:300px;
    height:19.75px;
    pointer-events:none;
  }
  .sessionBar{
    position:relative;
    width:100%; height:100%;
    border-radius:999px; overflow:hidden;
    background: rgba(106,162,192,.22);
  }
  .sessionFill{
    position:absolute; left:0; top:0;
    height:100%; width:0%;
    border-radius:inherit;
    background: linear-gradient(90deg, rgba(115,177,199,.85), rgba(106,162,192,1));
    transition: width .35s ease;
  }

  /* ===== Pinned Score/Hi numbers under art labels ===== */
  .scoreFixed{
    position:absolute; z-index:35; inset:0;
    pointer-events:none;
    font-weight:900;
    color:#1F4F66;
  }
  #scoreVal, #hiVal{
    position:absolute;
    font-size: clamp(16px, 4.5vw, 22px);
    line-height:1;
    letter-spacing:.5px;
    text-shadow:0 2px 8px rgba(31,79,102,.12);
  }
  #hiVal{ transform:translateX(-100%) }
</style>

<script defer>
window.addEventListener('DOMContentLoaded', () => {
/* =============================
   CONSTANTS
============================= */
const HEART_INTERVAL_MS = 700;   // unchanged
const LETTER_INTERVAL_MS = 360;  // unchanged
const HEART_SPEED_MS    = 420;   // unchanged
const LETTER_SPEED_MS   = 1100;  // unchanged
const ATTEMPT_SECONDS   = 10;
const RETRY_OVERLAY_MS  = 1200;
const FIRST_DELAY_MS    = 3000;

/* Require a few letter-heart hits (tokens) to win (unchanged request) */
const LETTER_HITS_TO_WIN = 3;

/* ===== Scoring constants (unchanged) ===== */
const MAX_SCORE_ATT1 = 100;
const MAX_SCORE_ATT2 = 70;
const MAX_SCORE_ATT3 = 40;
const OPTIMAL_RT_S   = 3.0;
const RT_SPREAD_S    = 3.0;

/* =============================
   VIEWPORT HEIGHT VARIABLE
============================= */
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);

/* =============================
   HELPERS
============================= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const shuffle = (a)=>{ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; };
const lettersOnly = /[A-Za-zÀ-ÖØ-öø-ÿ]/;

function fitTextTo(el, minPx=12, step=1){
  const cs = getComputedStyle(el);
  let size = parseFloat(cs.fontSize);
  const lineH = parseFloat(cs.lineHeight) || 1.25 * size;
  const maxLoops = 12; let loops=0;
  while (el.scrollHeight > el.clientHeight && size > minPx && loops < maxLoops){
    size = Math.max(minPx, size - step);
    el.style.fontSize = size + "px";
    el.style.lineHeight = Math.max(1.15, (size/lineH)*1.25);
    loops++;
  }
}

/* Keep target chips on one line by shrinking gently */
function fitToOneLine(el, minPx=11, step=0.5){
  el.style.fontSize = "";
  const cs = getComputedStyle(el);
  let size = parseFloat(cs.fontSize) || 16;
  const maxLoops = 40; let loops = 0;
  while ((el.scrollWidth > el.clientWidth) && size > minPx && loops < maxLoops){
    size -= step;
    el.style.fontSize = size + "px";
    loops++;
  }
}
function fitTargetsToOneLine(){
  const L = document.getElementById('leftBox');
  const R = document.getElementById('rightBox');
  if (L) fitToOneLine(L);
  if (R) fitToOneLine(R);
}

function obfuscateOneLetter(word){
  const idxs=[]; for(let i=0;i<word.length;i++){ if(lettersOnly.test(word[i])) idxs.push(i); }
  const pick = idxs[Math.floor(Math.random()*idxs.length)];
  const missingChar = word[pick];
  const masked = word.substring(0,pick)+"_"+word.substring(pick+1);
  return { masked, missingChar, index: pick };
}
function decorateMasked(masked){ return masked.replace("_",'<span class="slot pulse">_</span>'); }
function makeReinforcementLine(s,positive){
  const cut=s.split(";")[0].trim();
  let phrase=cut;
  const i=phrase.toLowerCase().indexOf("your partner ");
  if(i>=0) phrase="your partner "+phrase.slice(i+"your partner ".length);
  phrase=phrase.replace(/[.?!]\s*$/,"");
  return `the reason ${phrase} was ${positive}.`;
}

/* ====== Non-word generator (same length, different missing index) ====== */
function isLetter(ch){ return lettersOnly.test(ch); }
function genNonWordLike(template, forbiddenIndex){
  const chars = template.split("");
  const letterIdxs = [];
  for (let i=0;i<chars.length;i++){ if (isLetter(chars[i])) letterIdxs.push(i); }
  if (!letterIdxs.length){
    return { masked: "_", index: 0 };
  }
  // pick a mask index different from the positive's missing index
  let maskIndex = letterIdxs[Math.floor(Math.random()*letterIdxs.length)];
  if (maskIndex === forbiddenIndex){
    const alt = letterIdxs.filter(i=>i!==forbiddenIndex);
    maskIndex = alt[Math.floor(Math.random()*alt.length)];
  }
  const vowels = "aeiou";
  const consonants = "bcdfghjklmnpqrstvwxyz";
  const out = chars.map((ch,i)=>{
    if (!isLetter(ch)) return ch;
    const pool = vowels.includes(ch.toLowerCase()) ? vowels : consonants;
    let r = pool[Math.floor(Math.random()*pool.length)];
    if (ch === ch.toUpperCase()) r = r.toUpperCase();
    return (i===maskIndex) ? "_" : r;
  }).join("");
  return { masked: out, index: maskIndex };
}

/* =============================
   SCENARIOS (unchanged content)
============================= */
const SCENARIOS=[{"id":"S01","scenario":"After emails, your partner rubs their eyes and squints at the screen; you tell yourself it’s ______.","positive":"eye strain","negative":"migraine onset"},
{"id":"S02","scenario":"On a chilly walk, they cough a few times and clear their throat; maybe it’s ______.","positive":"dry air","negative":"chest cold"},
{"id":"S03","scenario":"Their smartwatch flags heart rate while resting; you think it’s ______.","positive":"device glitch","negative":"heart arrhythmia"},
{"id":"S04","scenario":"A clinic voicemail asks for a call back without details; probably ______.","positive":"routine reminder","negative":"abnormal results"},
{"id":"S05","scenario":"They cancel tonight with a small heart emoji; perhaps ______.","positive":"simple tiredness","negative":"pain flare"},
{"id":"S06","scenario":"Standing up, they wince and hold a knee; maybe ______.","positive":"brief stiffness","negative":"joint inflammation"},
{"id":"S07","scenario":"They read a doctor-portal message silently, face blank; likely ______.","positive":"appointment confirmation","negative":"medical concern"},
{"id":"S08","scenario":"They ask you to repeat twice, gaze drifting; maybe ______.","positive":"mild distraction","negative":"brain fog"},
{"id":"S09","scenario":"After one flight of stairs, they breathe fast; could be ______.","positive":"normal exertion","negative":"asthma flare"},
{"id":"S10","scenario":"Halfway through dinner, they push the plate away; you guess ______.","positive":"early snack","negative":"nausea wave"},
{"id":"S11","scenario":"Afternoon, they nap with a short timer; it’s probably ______.","positive":"quick recharge","negative":"persistent fatigue"},
{"id":"S12","scenario":"After spicy food, they press the chest briefly; maybe ______.","positive":"simple heartburn","negative":"chest pain"},
{"id":"S13","scenario":"Up at night to pee, then restless; perhaps ______.","positive":"extra hydration","negative":"urinary infection"},
{"id":"S14","scenario":"They misplace keys again and laugh; you think ______.","positive":"mental overload","negative":"memory decline"},
{"id":"S15","scenario":"They dim bright lights and rub temples; likely ______.","positive":"light preference","negative":"migraine sensitivity"},
{"id":"S16","scenario":"On a call, they keep clearing their throat; maybe ______.","positive":"dry throat","negative":"acid reflux"},
{"id":"S17","scenario":"After lifting a bag, they hold lower back; feels like ______.","positive":"minor strain","negative":"back injury"},
{"id":"S18","scenario":"Your supportive text gets “Can we talk later?”; probably ______.","positive":"work busyness","negative":"emotional distress"},
{"id":"S19","scenario":"They chew slowly and touch the jaw; maybe ______.","positive":"spice irritation","negative":"jaw pain"},
{"id":"S20","scenario":"They grip the stair rail briefly before stepping; perhaps ______.","positive":"extra caution","negative":"sudden dizziness"},
{"id":"S21","scenario":"Sitting after a big meal, they press the belly; could be ______.","positive":"tight clothing","negative":"abdominal cramping"},
{"id":"S22","scenario":"They sit on the shower floor for a minute; maybe ______.","positive":"deep relaxation","negative":"near fainting"},
{"id":"S23","scenario":"They cancel a walk when clouds gather; you think ______.","positive":"light drizzle","negative":"symptom flare"},
{"id":"S24","scenario":"They reach for pain pills, then put them back; perhaps ______.","positive":"testing restraint","negative":"worsening pain"},
{"id":"S25","scenario":"Mid-story, they pause to find a word; likely ______.","positive":"momentary pause","negative":"cognitive slowdown"},
{"id":"S26","scenario":"After a long drive, they rub one calf; maybe ______.","positive":"travel stiffness","negative":"blood clot"},
{"id":"S27","scenario":"They retake a home blood-pressure reading; perhaps ______.","positive":"simple curiosity","negative":"elevated pressure"},
{"id":"S28","scenario":"They skip game night and go quiet; could be ______.","positive":"needed downtime","negative":"social anxiety"},
{"id":"S29","scenario":"At the store, they study food labels; you think ______.","positive":"budget planning","negative":"medical restriction"},
{"id":"S30","scenario":"Standing up, they steady on the table for a moment; maybe ______.","positive":"gentle stretch","negative":"lightheaded spell"},
{"id":"S31","scenario":"Your long text gets a quick “k”; probably ______.","positive":"busy multitasking","negative":"hidden irritation"},
{"id":"S32","scenario":"Walking in dim light, they touch the wall; maybe ______.","positive":"casual stretch","negative":"balance trouble"}];

/* =============================
   STATE & ELEMENTS
============================= */
let order = [];
let idx = 0;
let seconds = 0;
let timerId = null;
let trialActive = false;
let attempts = 0;
let posSide = "L";
let missing = { masked:"", missingChar:"", index:-1 };
let firing = false, fireTimer = null, letterTimer = null, currentSide = "L";
let firstDelayTO = null;

/* token to invalidate hearts from previous trials */
let currentTrialToken = 0;

/* count how many letter-hearts have landed on the correct target this attempt */
let letterHits = 0;

/* ===== scoring state ===== */
let attemptStartMs = 0;
let totalScore = 0;
let hiScore   = 0;

/* ===== Elements ===== */
const frameEl   = $("#frame"),
      sceneEl   = $("#scene"),
      targetsEl = document.querySelector(".targets"),
      leftBox   = $("#leftBox"),
      rightBox  = $("#rightBox");

frameEl.addEventListener("selectstart",  e => e.preventDefault());
frameEl.addEventListener("contextmenu",  e => e.preventDefault());
frameEl.addEventListener("dragstart",    e => e.preventDefault());

const timerEl   = $("#timer"),
      hudTop    = $("#hudTop"),
      hudTimer  = $("#hudTimer"),
      hudTries  = $("#hudTries");

/* pinned score/hi */
const scoreValEl = $("#scoreVal");
const hiValEl    = $("#hiVal");

const overlay   = $("#overlay"),
      ovTitle   = $("#ovTitle"),
      ovMsg     = $("#ovMsg"),
      bigRetry  = $("#bigRetry"),
      bigRetryMsg=$("#bigRetryMsg"),
      successOverlay = $("#successOverlay"),
      successMsg = $("#successMsg"),
      continueBtn = $("#continueBtn"),
      retryScenarioBtn = $("#retryScenarioBtn"),
      restartSessionBtn = $("#restartSessionBtn"),
      startOverlay = $("#startOverlay"),
      startBtn = $("#startBtn"),
      shipBtn = $("#shipBtn"),
      homeBtn = $("#homeBtn");

shipBtn.addEventListener("selectstart", e => e.preventDefault());
shipBtn.addEventListener("contextmenu", e => e.preventDefault());
shipBtn.addEventListener("dragstart",   e => e.preventDefault());

const sessionFill = $("#sessionFill");
const sessionWrap = $("#sessionWrap");

/* Home overlay controls */
const tabButtons = ()=>$$('.tabBtn');
const showTab = (id)=>{
  $$('.homeSec').forEach(sec => sec.classList.add('hidden'));
  $('#'+id).classList.remove('hidden');
  tabButtons().forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
};

/* Score history storage */
function getScoreHistory(){
  try{ return JSON.parse(localStorage.getItem('ib_scoreHistory')||'[]'); }catch(e){ return []; }
}
function setScoreHistory(arr){
  try{ localStorage.setItem('ib_scoreHistory', JSON.stringify(arr)); }catch(e){}
}
function addScoreHistory(score){
  const hist = getScoreHistory();
  hist.push({score, ts: Date.now()});
  hist.sort((a,b)=> (b.score - a.score) || (b.ts - a.ts));
  setScoreHistory(hist.slice(0,200));
}
function renderHomeScores(){
  const list = $("#scoreList");
  const hi = getHiScore();
  const hist = getScoreHistory();
  $("#homeHiVal").textContent = String(hi);
  list.innerHTML = "";
  if (!hist.length){
    const li = document.createElement('li');
    li.textContent = "No scores yet. Play a session to see results here.";
    list.appendChild(li);
    return;
  }
  hist.forEach((h,i)=>{
    const d = new Date(h.ts);
    const li = document.createElement('li');
    const left = document.createElement('span');
    left.textContent = `${String(i+1).padStart(2,'0')}. ${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    const right = document.createElement('strong');
    right.textContent = h.score;
    li.appendChild(left); li.appendChild(right);
    list.appendChild(li);
  });
}

/* =============================
   UI helpers
============================= */
let aimSide = null;
function setAim(side){
  if (aimSide === side) return;
  [leftBox, rightBox].forEach(el => el.classList.remove('aim'));
  (side === "L" ? leftBox : rightBox).classList.add('aim');
  aimSide = side;
}
function pulseRipple(el){
  el.classList.remove('ripple');
  void el.offsetWidth;
  el.classList.add('ripple');
}
function clearHearts(){
  document.querySelectorAll('.heart').forEach(h=>h.remove());
}

/* ===== ART METRICS & PINNING ===== */
const PB_LEFT  = 0.08;
const PB_WIDTH = 0.84;
const PB_TOP   = 0.912;

/* numeric SCORE/HI positions (under artwork labels) */
const SCORE_LEFT_PCT = 0.131;
const SCORE_TOP_PCT  = 0.08;
const HI_RIGHT_PCT   = 0.05;
const HI_TOP_PCT     = 0.08;

let _artNat = { w: 0, h: 0 };

function _computeArtRect(){
  const fr = frameEl.getBoundingClientRect();
  const natW = _artNat.w || 900;
  const natH = _artNat.h || 1950;
  const scale = Math.min(fr.width / natW, fr.height / natH);
  const artW = natW * scale;
  const artH = natH * scale;
  const artLeft = (fr.width - artW) / 2;
  const artTop  = 0;
  return { artW, artH, artLeft, artTop };
}

function pinSessionBar(){
  if (!sessionWrap) return;
  const fr = frameEl.getBoundingClientRect();
  const { artW, artH, artLeft, artTop } = _computeArtRect();

  const pxLeft  = fr.left + artLeft + artW * PB_LEFT;
  const pxTop   = fr.top  + artTop  + artH * PB_TOP;

  sessionWrap.style.left  = (pxLeft - fr.left) + "px";
  sessionWrap.style.top   = (pxTop - fr.top - sessionWrap.offsetHeight/2) + "px";
  sessionWrap.style.width = (artW * PB_WIDTH) + "px";
}

/* pin score & hi numbers under the graphic labels */
function pinScoreHi(){
  const fr = frameEl.getBoundingClientRect();
  const { artW, artH, artLeft, artTop } = _computeArtRect();

  // SCORE (left anchored)
  const sLeft = fr.left + artLeft + artW * SCORE_LEFT_PCT;
  const sTop  = fr.top  + artTop  + artH * SCORE_TOP_PCT;
  scoreValEl.style.left = (sLeft - fr.left) + "px";
  scoreValEl.style.top  = (sTop - fr.top)  + "px";

  // HI (right anchored using translateX(-100%))
  const hLeft = fr.left + artLeft + artW * (1 - HI_RIGHT_PCT);
  const hTop  = fr.top  + artTop  + artH * HI_TOP_PCT;
  hiValEl.style.left = (hLeft - fr.left) + "px";
  hiValEl.style.top  = (hTop  - fr.top)  + "px";
}

/* Place the Home button inside the artwork, away from SCORE/HI */
const HOMEBTN_LEFT_PCT = 0.03; // 3% from art’s left edge
const HOMEBTN_TOP_PCT  = 0.955; // 3% from art’s top edge
function pinHomeBtn(){
  const fr = frameEl.getBoundingClientRect();
  const { artW, artH, artLeft, artTop } = _computeArtRect();

  const leftPx = fr.left + artLeft + artW * HOMEBTN_LEFT_PCT;
  const topPx  = fr.top  + artTop  + artH * HOMEBTN_TOP_PCT;

  homeBtn.style.left = (leftPx - fr.left) + "px";
  homeBtn.style.top  = (topPx  - fr.top ) + "px";
}

const _bg = new Image();
_bg.src = "Main_frame.png";
_bg.onload = () => {
  _artNat.w = _bg.naturalWidth;
  _artNat.h = _bg.naturalHeight;
  pinSessionBar();
  pinScoreHi();
  pinHomeBtn();
};
window.addEventListener("resize", ()=>{ pinSessionBar(); pinScoreHi(); pinHomeBtn(); setVH(); });
window.addEventListener("orientationchange", ()=>{ pinSessionBar(); pinScoreHi(); pinHomeBtn(); setVH(); });

/* =============================
   TIMER
============================= */
function startAnswerWindow(limit,onEnd){
  clearInterval(timerId);
  seconds = limit;
  timerEl && (timerEl.textContent = String(seconds));
  hudTimer && (hudTimer.textContent = String(seconds));
  attemptStartMs = performance.now();
  timerId = setInterval(()=>{
    seconds -= 1;
    const s = String(Math.max(0,seconds));
    timerEl && (timerEl.textContent = s);
    hudTimer && (hudTimer.textContent = s);
    if (seconds <= 0){
      clearInterval(timerId);
      onEnd();
    }
  },1000);
}

/* =============================
   ATTEMPTS
============================= */
function startAttempt(isFirst){
  stopFiring(); enableShipControls(false);
  clearInterval(timerId);
  clearHearts();
  letterHits = 0;  // reset required token count each attempt

  if (isFirst){
    targetsEl.style.visibility = "hidden";
    hudTop.style.opacity = "0";
    toggleShake(false);
    clearTimeout(firstDelayTO);
    firstDelayTO = setTimeout(()=>{
      targetsEl.style.visibility = "visible";
      leftBox.classList.add("shake"); rightBox.classList.add("shake");
      hudTop.style.opacity = "1";
      startAnswerWindow(ATTEMPT_SECONDS,()=>registerFailAttempt("timeout"));
      enableShipControls(true);
      fitTargetsToOneLine();
    }, FIRST_DELAY_MS);
  } else {
    targetsEl.style.visibility = "visible";
    hudTop.style.opacity = "1";
    toggleShake(true);
    startAnswerWindow(ATTEMPT_SECONDS,()=>registerFailAttempt("timeout"));
    enableShipControls(true);
    fitTargetsToOneLine();
  }
}

/* =============================
   TRIAL FLOW
============================= */
function showTrial(sc){
  currentTrialToken++;
  clearHearts();

  trialActive=true; attempts=0;
  hudTries && (hudTries.textContent = "0/3");
  sceneEl.style.fontSize = ""; sceneEl.style.lineHeight = "";
  sceneEl.innerHTML = sc.scenario.replace(";", ";<br>");
  fitTextTo(sceneEl);

  leftBox.className="target";
  rightBox.className="target";

  const posOnLeft=Math.random()<0.5; posSide=posOnLeft?"L":"R";
  leftBox.dataset.correct=posOnLeft?"1":"0";
  rightBox.dataset.correct=posOnLeft?"0":"1";

  missing=obfuscateOneLetter(sc.positive);
  const posHTML=`[ ${decorateMasked(missing.masked)} ]`;

  /* New: create a non-word alternative with a different missing index */
  const nonw = genNonWordLike(sc.positive, missing.index);
  const nonHTML = `[ ${decorateMasked(nonw.masked)} ]`;

  leftBox.innerHTML  = posOnLeft ? posHTML : nonHTML;
  rightBox.innerHTML = posOnLeft ? nonHTML : posHTML;

  fitTargetsToOneLine();
  startAttempt(true);
  updateProgress();
}

function nextTrial(){
  bigRetry.style.display="none";
  successOverlay.style.display="none";
  overlay.style.display="none";
  clearTimeout(firstDelayTO);
  clearHearts();

  if (idx >= order.length){
    const prevHi = getHiScore();
    let newHi = prevHi;
    let isNewHi = false;
    if (totalScore > prevHi){
      newHi = totalScore;
      setHiScore(newHi);
      isNewHi = true;
    }
    addScoreHistory(totalScore); // store in history

    ovTitle.textContent = "Session Complete";
    ovMsg.innerHTML = `Well done! You’ve finished all scenarios in this session.<br><br><strong>Score:</strong> ${totalScore}${isNewHi ? ' <span style="color:#1F4F66; font-weight:900">— New High!</span>' : ''}<br><small>High score: ${newHi}</small>`;
    overlay.style.display = "flex";
    retryScenarioBtn && (retryScenarioBtn.style.display = "none");
    if (restartSessionBtn){
      restartSessionBtn.style.display = "inline-flex";
      restartSessionBtn.textContent = "Play Again";
    }
    // Show Home button on completion overlay
    const homeBtn2 = $("#homeFromOverlay");
    if (homeBtn2) homeBtn2.style.display = "inline-flex";
    return;
  }
  showTrial(SCENARIOS[order[idx]]);
}

/* =============================
   SHIP & FIRING
============================= */
function setShipX(docX){
  const fr = frameEl.getBoundingClientRect();
  const half = shipBtn.offsetWidth / 2;
  const minX = fr.left + 20 + half;
  const maxX = fr.right - 20 - half;
  const clamped = Math.min(Math.max(docX, minX), maxX);
  shipBtn.style.left = (clamped - fr.left - half) + "px";
}
function updateSide(clientX){
  const fr = frameEl.getBoundingClientRect();
  currentSide = (clientX < fr.left + fr.width/2) ? "L" : "R";
  setAim(currentSide);
}
function onPointerDown(e){
  if (!trialActive || seconds <= 0) return;
  e.preventDefault();
  setShipX(e.clientX);
  updateSide(e.clientX);
  startFiring();
  window.addEventListener("pointermove", onPointerMove, {passive:false});
  window.addEventListener("pointerup", onPointerUp, {once:true});
  window.addEventListener("pointercancel", onPointerUp, {once:true});
}
function onPointerMove(e){
  setShipX(e.clientX);
  updateSide(e.clientX);
}
function onPointerUp(){
  stopFiring();
  window.removeEventListener("pointermove", onPointerMove);
}

shipBtn.addEventListener("contextmenu", e => e.preventDefault());
shipBtn.addEventListener("dragstart",  e => e.preventDefault());

function startFiring(){
  if (firing || !trialActive || seconds <= 0) return;
  firing = true;
  fireTimer = setInterval(()=>emitHeart(currentSide,false), HEART_INTERVAL_MS);
  startLetterTimer();   // immediate (unchanged behavior)
}
function startLetterTimer(){
  if (letterTimer) return;
  letterTimer = setInterval(()=>{
    if (!trialActive || seconds <= 0) return;
    if (currentSide === posSide){
      emitHeart(currentSide, true);
      if (navigator.vibrate){ try{ navigator.vibrate(12); }catch(e){} }
    }
  }, LETTER_INTERVAL_MS);
}
function stopFiring(){
  firing = false;
  clearInterval(fireTimer); fireTimer = null;
  clearInterval(letterTimer); letterTimer = null;
}
function enableShipControls(on){
  shipBtn.style.opacity = on ? "1" : ".6";
  shipBtn.style.pointerEvents = on ? "auto" : "none";
  if (on){
    shipBtn.addEventListener("pointerdown", onPointerDown);
  } else {
    shipBtn.removeEventListener("pointerdown", onPointerDown);
  }
}

/* =============================
   HEARTS (projectiles)
============================= */
function emitHeart(side,isLetter){
  const myToken = currentTrialToken;

  const fr=frameEl.getBoundingClientRect();
  const shipRect=shipBtn.getBoundingClientRect();
  const startX=shipRect.left+shipRect.width/2-fr.left;
  const startY=shipRect.top+shipRect.height/2-fr.top;

  const targetEl=(side==="L")?leftBox:rightBox;
  const tRect=targetEl.getBoundingClientRect();
  const endX=tRect.left+tRect.width/2-fr.left;
  const endY=tRect.top+tRect.height/2-fr.top;

  const heart=document.createElement("div");
  heart.className="heart"+(isLetter?" letter":"");
  heart.innerHTML=isLetter?`❤<span class="letterglyph">${missing.missingChar}</span>`:"❤";
  frameEl.appendChild(heart);

  const dur=isLetter?LETTER_SPEED_MS:HEART_SPEED_MS;
  const t0=performance.now();
  function step(t){
    if (myToken !== currentTrialToken){ heart.remove(); return; }
    const p=Math.min(1,(t-t0)/dur);
    heart.style.left=(startX+(endX-startX)*p)+"px";
    heart.style.top =(startY+(endY-startY)*p)+"px";
    if(p<1){
      requestAnimationFrame(step);
    } else {
      if(myToken !== currentTrialToken || !trialActive || seconds <= 0){ heart.remove(); return; }
      pulseRipple(targetEl);
      const good = targetEl.dataset.correct==="1";
      targetEl.classList.remove("goodflash","badflash");
      targetEl.classList.add(good?"goodflash":"badflash");
      setTimeout(()=>targetEl.classList.remove("goodflash","badflash"),260);

      if (good && isLetter){
        letterHits += 1;
        if (letterHits >= LETTER_HITS_TO_WIN){
          onCorrect();
        }
      }
      heart.remove();
    }
  }
  requestAnimationFrame(step);
}

/* =============================
   FEEDBACK / OVERLAYS
============================= */
function toggleShake(on){
  for(const el of [leftBox,rightBox]){
    el.classList.remove("shake");
    if(on) el.classList.add("shake");
  }
}
function registerFailAttempt(kind){
  if(!trialActive) return;

  stopFiring(); enableShipControls(false);
  clearTimeout(firstDelayTO);
  clearHearts();

  if(kind==="timeout"){
    attempts += 1;
    hudTries && (hudTries.textContent = Math.min(attempts,3) + "/3");

    if (attempts >= 3){
      trialActive=false; clearInterval(timerId); toggleShake(false);
      overlay.style.display="flex";
      ovTitle.textContent = "Session Restart Needed";
      ovMsg.innerHTML = `You need to start over from the beginning.`;
      retryScenarioBtn && (retryScenarioBtn.style.display = "none");
      if (restartSessionBtn){
        restartSessionBtn.style.display = "inline-flex";
        restartSessionBtn.textContent = "Restart Session";
      }
      const homeBtn2 = $("#homeFromOverlay");
      if (homeBtn2) homeBtn2.style.display = "inline-flex";
      return;
    } else {
      bigRetryMsg.textContent = "Time is over, lets try again.";
      bigRetry.style.display = "flex";
      setTimeout(()=>{
        bigRetry.style.display = "none";
        startAttempt(false);
      }, RETRY_OVERLAY_MS);
      return;
    }
  }
}

function onCorrect(){
  if(!trialActive || seconds <= 0) return;
  trialActive=false;
  enableShipControls(false);
  stopFiring();
  clearInterval(timerId);
  toggleShake(false);
  clearTimeout(firstDelayTO);
  clearHearts();

  const sc=SCENARIOS[order[idx]];
  const posEl=(posSide==="L")?leftBox:rightBox;
  posEl.innerHTML=`[ ${sc.positive} ]`;
  posEl.classList.add("reinforce");
  setTimeout(()=>posEl.classList.remove("reinforce"),300);

  sceneEl.innerHTML = sc.scenario
    .replace(/______/, sc.positive)
    .replace(";", ";<br>");
  fitTextTo(sceneEl);
  fitToOneLine(posEl);

  /* scoring */
  const rtSec = Math.max(0, (performance.now() - attemptStartMs)/1000);
  const attemptNumber = attempts + 1;
  const gained = scoreAttempt(rtSec, attemptNumber);
  totalScore += gained;
  updateScoreHUD();

  successMsg.textContent = makeReinforcementLine(sc.scenario, sc.positive);
  successOverlay.style.display="flex";
}

/* ===== scoring functions ===== */
function scoreAttempt(rtSec, attemptNumber){
  if (attemptNumber === 1){
    const norm = 1 - Math.pow((rtSec - OPTIMAL_RT_S)/RT_SPREAD_S, 2);
    const pts = Math.max(0, Math.round(MAX_SCORE_ATT1 * Math.max(0, norm)));
    return pts;
  } else if (attemptNumber === 2){
    const pts = Math.max(0, Math.round(MAX_SCORE_ATT2 * (1 - (rtSec / ATTEMPT_SECONDS))));
    return pts;
  } else {
    const pts = Math.max(0, Math.round(MAX_SCORE_ATT3 * (1 - (rtSec / ATTEMPT_SECONDS))));
    return pts;
  }
}
function updateScoreHUD(){
  if (scoreValEl) scoreValEl.textContent = String(totalScore);
  if (hiValEl)    hiValEl.textContent    = String(getHiScore());
}
function getHiScore(){
  if (typeof localStorage === "undefined") return hiScore;
  const v = localStorage.getItem("ib_hiScore");
  return v ? parseInt(v,10) : hiScore;
}
function setHiScore(v){
  hiScore = v;
  try{ localStorage.setItem("ib_hiScore", String(v)); }catch(e){}
  updateScoreHUD();
}

/* =============================
   PROGRESS
============================= */
function updateProgress(){
  if (!sessionFill || !order.length) return;
  const pct = Math.round((idx / order.length) * 100);
  sessionFill.style.width = pct + "%";
}

/* =============================
   HOME / INIT / BUTTONS
============================= */
function goHome(){
  // return to Home without altering the UI skin elsewhere
  clearInterval(timerId);
  stopFiring();
  trialActive = false;
  enableShipControls(false);
  clearTimeout(firstDelayTO);
  clearHearts();
  homeBtn.style.display = "none";
  startOverlay.style.display = "flex";
  showTab("aboutTab");
  renderHomeScores();
  // keep current hi score visible
  updateScoreHUD();
}

function init(){
  order = shuffle(SCENARIOS.map((_,i)=>i));
  idx=0; trialActive=false; attempts=0;
  clearTimeout(firstDelayTO);
  currentTrialToken++;
  clearHearts();

  totalScore = 0;
  hiScore = getHiScore();
  updateScoreHUD();

  sceneEl.textContent="Press “Start” to begin.";
  sceneEl.style.fontSize=""; sceneEl.style.lineHeight="";
  leftBox.textContent="[ — — ]";
  rightBox.textContent="[ — — ]";
  hudTries && (hudTries.textContent = "0/3");
  hudTimer && (hudTimer.textContent = "10");
  hudTop.style.opacity = "1";
  targetsEl.style.visibility = "visible";
  stopFiring(); enableShipControls(false);
  startOverlay.style.display="flex";
  homeBtn.style.display = "none";
  renderHomeScores();
  showTab("aboutTab");
  updateProgress();

  pinSessionBar();
  pinScoreHi();
  pinHomeBtn();
  fitTargetsToOneLine();
}

/* Start button */
startBtn.addEventListener("click", async ()=>{
  // Try to enter fullscreen where supported
  const el = document.documentElement;
  try{
    if (el.requestFullscreen) {
      await el.requestFullscreen();
    } else if (el.webkitRequestFullscreen) { // Safari fallback
      el.webkitRequestFullscreen();
    }
  }catch(e){ /* ignore if denied */ }

  startOverlay.style.display="none";
  homeBtn.style.display = "inline-flex";
  pinHomeBtn();      // ensure correct in-art placement on start
  nextTrial();
});

/* Only start if background of overlay itself is clicked (not card/buttons) */
startOverlay.addEventListener("click", (e)=>{
  if (e.target === startOverlay){
    startOverlay.style.display="none";
    homeBtn.style.display = "inline-flex";
    nextTrial();
  }
});

/* In-game Home button */
homeBtn.addEventListener("click", ()=>{
  goHome();
});

/* Continue after correct */
continueBtn.addEventListener("click", ()=>{
  successOverlay.style.display="none";
  idx += 1;
  updateProgress();
  nextTrial();
});

/* Session restart / play again */
restartSessionBtn && restartSessionBtn.addEventListener("click", ()=>{
  overlay.style.display="none";
  idx=0;
  init();
});

/* Overlay Home buttons */
$("#homeFromOverlay")?.addEventListener("click", ()=>{
  overlay.style.display="none";
  goHome();
});
$("#homeFromSuccess")?.addEventListener("click", ()=>{
  successOverlay.style.display="none";
  goHome();
});

/* Tabs */
document.addEventListener("click",(e)=>{
  const btn = e.target.closest(".tabBtn");
  if (!btn) return;
  showTab(btn.dataset.tab);
});

/* boot */
init();
});
</script>
</head>

<body>
  <div class="frame" id="frame">

    <!-- In-game tiny Home button -->
    <button id="homeBtn" class="btn btnSmall">Home</button>

    <!-- Home / Start overlay -->
    <div id="startOverlay">
      <div class="homeCard" role="dialog" aria-modal="true">
        <div class="homeHeader">
          <h1 class="homeTitle">CBM-I Clinical Sky</h1>
          <div style="font-weight:800; opacity:.8">HI: <span id="homeHiVal">0</span></div>
        </div>
        <div class="homeNav">
          <button class="tabBtn active" data-tab="aboutTab">About</button>
          <button class="tabBtn" data-tab="scoresTab">Scores</button>
          <button class="tabBtn" data-tab="copyrightTab">Copyright</button>
        </div>
        <div class="homeBody">
          <section id="aboutTab" class="homeSec">
            <p style="margin:.25rem 0 .5rem">
              This training helps partner-caregivers practice choosing <strong>benign</strong> interpretations of ambiguous, health-related situations. Each scenario appears with two response chips. One contains the <em>positive resolution</em> with one letter missing. The other shows a <em>non-word</em> of similar length with a different missing-letter position.
            </p>
            <ul style="margin:.25rem 0 .5rem; padding-left:1.1rem">
              <li><strong>How to play:</strong> Hold the ship, aim toward the correct (benign) option, and keep it aligned. Your ship fires hearts; some deliver the missing letter. After a few letter-hits, the correct word resolves.</li>
              <li><strong>Timing:</strong> You get three attempts per scenario (10s each). If all three time out, the session restarts from the beginning.</li>
              <li><strong>Scoring:</strong> Faster resolution and earlier attempts earn more points. Your high score is saved locally on this device.</li>
              <li><strong>Background:</strong> This follows CBM-I (Cognitive Bias Modification for Interpretation) principles—repeated selection of benign meanings can reduce negative interpretation bias over time.</li>
            </ul>
          </section>

          <section id="scoresTab" class="homeSec hidden">
            <p style="margin:.25rem 0 .5rem">Your previous session scores on this device (highest first):</p>
            <ul id="scoreList" class="scoreList"></ul>
          </section>

          <section id="copyrightTab" class="homeSec hidden">
            <p style="margin:.25rem 0 .5rem">
              © 2025 <strong>Pouyan Alizadeh</strong>. All rights reserved.<br>
              All <em>code, graphics, and any audio</em> in this application are designed and produced by the author and are protected by copyright law. Unauthorized copying, distribution, or derivative use is prohibited without written permission.
            </p>
            <p style="margin:.25rem 0 .5rem">
              This training is for educational and wellness purposes and does not provide medical advice or diagnosis.
            </p>
          </section>
        </div>
        <div class="homeActions">
          <button id="startBtn" class="btn">Play</button>
        </div>
      </div>
    </div>

    <!-- Top center HUD (timer + tries only) -->
    <div class="hudTop" id="hudTop">
      <div class="hudScore" id="hudScore"></div>
      <div class="hudTimer" id="hudTimer">10</div>
      <div class="hudTries" id="hudTries">0/3</div>
    </div>

    <!-- Numeric SCORE/HI pinned under the artwork labels -->
    <div class="scoreFixed" aria-hidden="true">
      <div id="scoreVal">0</div>
      <div id="hiVal">0</div>
    </div>

    <div class="scene" id="scene">Press “Start” to begin.</div>

    <div class="targets">
      <div class="target" id="leftBox">[ — — ]</div>
      <div class="target" id="rightBox">[ — — ]</div>
    </div>

    <button id="restartBtn" style="position:absolute; left:-9999px; top:-9999px;" disabled>Restart</button>

    <div class="ship-wrap" id="shipWrap" style="z-index:6%;">
      <button id="shipBtn" aria-label="Hold to fire hearts">
        <img src="Ship_to_shoot.png" alt="" draggable="false">
      </button>
    </div>

    <div class="sessionWrap" id="sessionWrap" aria-label="Session progress">
      <div class="sessionBar">
        <div class="sessionFill" id="sessionFill" style="width:0%"></div>
      </div>
    </div>

    <div id="bigRetry"><div class="msg" id="bigRetryMsg">Time is over, lets try again.</div></div>

    <div id="successOverlay" role="dialog" aria-modal="true">
      <div class="panel">
        <h2 style="margin:0 0 6px">Nice!</h2>
        <p id="successMsg" style="margin:6px 0 12px">the reason your partner … was …</p>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:4px;">
          <button id="continueBtn" class="btn" style="padding:8px 14px">Continue</button>
          <button id="homeFromSuccess" class="btn" style="padding:8px 14px">Home</button>
        </div>
      </div>
    </div>

    <div id="overlay" role="dialog" aria-modal="true">
      <div class="panel">
        <h2 id="ovTitle" style="margin:0 0 6px">Session Restart Needed</h2>
        <p id="ovMsg" style="margin:6px 0 12px"></p>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
          <button id="retryScenarioBtn" class="btn" style="padding:8px 12px">Play This Scenario Again</button>
          <button id="restartSessionBtn" class="btn" style="padding:8px 12px">Restart Session</button>
          <button id="homeFromOverlay" class="btn" style="padding:8px 12px; display:none;">Home</button>
        </div>
      </div>
    </div>

    <div id="results" class="hidden">
      <div id="summary"></div>
      <pre id="log"></pre>
    </div>

  </div>
</body>
</html>
